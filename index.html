<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Splitter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs .nav-link {
            border: none;
            padding: 15px 25px;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.3s ease;
            border-radius: 15px 15px 0 0;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            transform: translateY(-2px);
        }

        .person-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .debt-item {
            border-left: 4px solid var(--warning);
            background: linear-gradient(135deg, #fff5f5, #fff);
        }

        .credit-item {
            border-left: 4px solid var(--success);
            background: linear-gradient(135deg, #f0fff4, #fff);
        }

        .expense-item {
            border-left: 4px solid var(--primary);
            background: linear-gradient(135deg, #f0f4ff, #fff);
        }

        .payment-item {
            border-left: 4px solid var(--info);
            background: linear-gradient(135deg, #f8f0ff, #fff);
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .amount-badge {
            font-size: 1.1em;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 12px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        .form-control, .form-select {
            border-radius: 12px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
            transform: translateY(-1px);
        }

        .transaction-card {
            transition: all 0.3s ease;
            border-radius: 15px;
            margin-bottom: 15px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .transaction-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .delete-btn {
            opacity: 0.7;
            transition: all 0.3s ease;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .transaction-card:hover .delete-btn {
            opacity: 1;
            transform: scale(1.1);
        }

        .split-checkbox {
            transform: scale(1.2);
            margin-right: 10px;
        }

        .section-title {
            color: var(--secondary);
            font-weight: 700;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
            padding-left: 15px;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .settlement-suggestion {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settlement-suggestion:hover {
            background: linear-gradient(135deg, #e3f2fd, #fff) !important;
        }

        .pdf-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="text-center mb-5">
            <div class="glass-card p-5 mb-4">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="bi bi-cash-stack"></i> Expense Splitter 
                </h1>
                <p class="lead text-muted mb-4">Smart expense tracking with beautiful insights</p>
                
                <!-- Quick Stats -->
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <i class="bi bi-receipt fs-1 mb-3"></i>
                            <h3 id="totalExpenses">‚Çπ0</h3>
                            <small>Total Expenses</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <i class="bi bi-arrow-left-right fs-1 mb-3"></i>
                            <h3 id="pendingSettlements">0</h3>
                            <small>Pending Settlements</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <i class="bi bi-people fs-1 mb-3"></i>
                            <h3>4</h3>
                            <small>Group Members</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation -->
        <div class="glass-card p-4 mb-4">
            <ul class="nav nav-tabs nav-justified" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard')">
                        <i class="bi bi-speedometer2 me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('expenses')">
                        <i class="bi bi-plus-circle me-2"></i>Add Expense
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('settlements')">
                        <i class="bi bi-cash-coin me-2"></i>Settlements
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('analytics')">
                        <i class="bi bi-graph-up me-2"></i>Analytics
                    </a>
                </li>
                <li class="nav-link" onclick="showSection('history')">
                    <i class="bi bi-clock-history me-2"></i>History
                </li>
            </ul>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section-content">
            <div class="row">
                <!-- Debts & Credits -->
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 h-100">
                        <h3 class="section-title"><i class="bi bi-arrow-down-left me-2"></i>Who Owes Money</h3>
                        <div id="debtsList"></div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 h-100">
                        <h3 class="section-title"><i class="bi bi-arrow-up-right me-2"></i>Who is Owed Money</h3>
                        <div id="creditsList"></div>
                    </div>
                </div>
            </div>

            <!-- Settlement Suggestions -->
            <div class="glass-card p-4 mb-4">
                <h3 class="section-title"><i class="bi bi-lightning me-2"></i>Smart Settlement Suggestions</h3>
                <div id="settlementSuggestions"></div>
            </div>

            <!-- Quick Actions -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="glass-card p-4 text-center h-100">
                        <i class="bi bi-receipt-cutoff fs-1 text-primary mb-3"></i>
                        <h5>Quick Expense</h5>
                        <p class="text-muted small">Add a new expense quickly</p>
                        <button class="btn btn-primary btn-sm" onclick="showSection('expenses')">Add Now</button>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="glass-card p-4 text-center h-100">
                        <i class="bi bi-cash-coin fs-1 text-success mb-3"></i>
                        <h5>Record Payment</h5>
                        <p class="text-muted small">Mark a payment as completed</p>
                        <button class="btn btn-success btn-sm" onclick="showSection('settlements')">Record</button>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="glass-card p-4 text-center h-100">
                        <i class="bi bi-download fs-1 text-info mb-3"></i>
                        <h5>Export Report</h5>
                        <p class="text-muted small">Download beautiful PDF report</p>
                        <button class="btn btn-info btn-sm" onclick="generatePDFReport()">Export PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Expense Section -->
        <div id="expensesSection" class="section-content" style="display: none;">
            <div class="row">
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h3 class="section-title"><i class="bi bi-plus-circle me-2"></i>Add New Expense</h3>
                        <form id="expenseForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">What was the expense for?</label>
                                <input type="text" class="form-control" id="expenseDesc" placeholder="Dinner, Groceries, Movie tickets..." required>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Amount (‚Çπ)</label>
                                    <input type="number" class="form-control" id="expenseAmount" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Date</label>
                                    <input type="date" class="form-control" id="expenseDate" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Who paid for this?</label>
                                <select class="form-select" id="paidBy" required>
                                    <option value="">Select person...</option>
                                    <option value="arsif">Arsif Akhtar</option>
                                    <option value="yashraj">Yashraj Upadhyaya</option>
                                    <option value="zeshan">Zeshan Ahmed</option>
                                    <option value="sandeep">Sandeep Verma</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">Split between:</label>
                                <div id="splitContainer" class="border rounded p-3">
                                    <!-- Checkboxes will be added here -->
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-check-lg me-2"></i> Add Expense
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="glass-card p-4 mb-4">
                        <h3 class="section-title"><i class="bi bi-list-ul me-2"></i>Recent Expenses</h3>
                        <div id="recentExpenses"></div>
                    </div>

                    <div class="glass-card p-4">
                        <h3 class="section-title"><i class="bi bi-people me-2"></i>Group Members</h3>
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="person-avatar bg-primary mx-auto mb-2">A</div>
                                <div class="fw-bold">Arsif</div>
                                <small class="text-muted">Akhtar</small>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="person-avatar bg-success mx-auto mb-2">Y</div>
                                <div class="fw-bold">Yashraj</div>
                                <small class="text-muted">Upadhyaya</small>
                            </div>
                            <div class="col-6">
                                <div class="person-avatar bg-warning mx-auto mb-2">Z</div>
                                <div class="fw-bold">Zeshan</div>
                                <small class="text-muted">Ahmed</small>
                            </div>
                            <div class="col-6">
                                <div class="person-avatar bg-info mx-auto mb-2">S</div>
                                <div class="fw-bold">Sandeep</div>
                                <small class="text-muted">Verma</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settlements Section -->
        <div id="settlementsSection" class="section-content" style="display: none;">
            <div class="row">
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h3 class="section-title"><i class="bi bi-cash-coin me-2"></i>Record Payment</h3>
                        <form id="paymentForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">From (Who is receiving payment)</label>
                                <select class="form-select" id="paymentFrom" required>
                                    <option value="">Select person...</option>
                                    <option value="arsif">Arsif Akhtar</option>
                                    <option value="yashraj">Yashraj Upadhyaya</option>
                                    <option value="zeshan">Zeshan Ahmed</option>
                                    <option value="sandeep">Sandeep Verma</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">To (Who is making payment)</label>
                                <select class="form-select" id="paymentTo" required>
                                    <option value="">Select person...</option>
                                    <option value="arsif">Arsif Akhtar</option>
                                    <option value="yashraj">Yashraj Upadhyaya</option>
                                    <option value="zeshan">Zeshan Ahmed</option>
                                    <option value="sandeep">Sandeep Verma</option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Amount (‚Çπ)</label>
                                    <input type="number" class="form-control" id="paymentAmount" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Date</label>
                                    <input type="date" class="form-control" id="paymentDate" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Notes (Optional)</label>
                                <input type="text" class="form-control" id="paymentNotes" placeholder="Dinner payment, Rent share...">
                            </div>

                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-check-lg me-2"></i> Record Payment
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="glass-card p-4 mb-4">
                        <h3 class="section-title"><i class="bi bi-receipt me-2"></i>Export & Reports</h3>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="generatePDFReport()">
                                <i class="bi bi-file-pdf me-2"></i> Export PDF Report
                            </button>
                            <button class="btn btn-success" onclick="exportToCSV()">
                                <i class="bi bi-file-spreadsheet me-2"></i> Export to CSV
                            </button>
                            <button class="btn btn-info" onclick="backupData()">
                                <i class="bi bi-cloud-arrow-down me-2"></i> Backup Data
                            </button>
                        </div>
                    </div>

                    <div class="glass-card p-4">
                        <h3 class="section-title"><i class="bi bi-clock-history me-2"></i>Recent Payments</h3>
                        <div id="recentPayments"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="section-content" style="display: none;">
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="glass-card p-4">
                        <h3 class="section-title"><i class="bi bi-bar-chart me-2"></i>Spending Overview</h3>
                        <canvas id="spendingChart" height="250"></canvas>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="glass-card p-4">
                        <h3 class="section-title"><i class="bi bi-pie-chart me-2"></i>Expense Distribution</h3>
                        <canvas id="distributionChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="section-content" style="display: none;">
            <div class="glass-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="section-title mb-0"><i class="bi bi-clock-history me-2"></i>Complete History</h3>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control" id="historySearch" placeholder="Search transactions...">
                        <button class="btn btn-outline-primary" onclick="clearAllData()">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                <div id="completeHistory"></div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="floating-action-btn" onclick="showQuickExpenseModal()">
        <i class="bi bi-plus"></i>
    </button>

    <!-- Quick Expense Modal -->
    <div class="modal fade" id="quickExpenseModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="quickDesc" placeholder="Description">
                    <input type="number" class="form-control mb-3" id="quickAmount" placeholder="Amount">
                    <select class="form-select mb-3" id="quickPaidBy">
                        <option value="arsif">Arsif</option>
                        <option value="yashraj">Yashraj</option>
                        <option value="zeshan">Zeshan</option>
                        <option value="sandeep">Sandeep</option>
                    </select>
                    <button class="btn btn-primary w-100" onclick="addQuickExpense()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">PDF Report Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="pdfPreviewContent" class="pdf-preview"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadPDF()">
                        <i class="bi bi-download me-2"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enhanced Data Management
        const people = [
            { id: 'arsif', name: 'Arsif Akhtar', color: 'primary' },
            { id: 'yashraj', name: 'Yashraj Upadhyaya', color: 'success' },
            { id: 'zeshan', name: 'Zeshan Ahmed', color: 'warning' },
            { id: 'sandeep', name: 'Sandeep Verma', color: 'info' }
        ];

        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            initializeSplitCheckboxes();
            loadRecentExpenses();
            loadRecentPayments();
            updateDashboard();
            loadCompleteHistory();
            initializeCharts();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            document.getElementById('paymentDate').value = today;

            // Form submissions
            document.getElementById('expenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addExpense();
            });

            document.getElementById('paymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                recordPayment();
            });

            // Search functionality
            document.getElementById('historySearch').addEventListener('input', function(e) {
                filterHistory(e.target.value);
            });
        }

        function initializeSplitCheckboxes() {
            const container = document.getElementById('splitContainer');
            container.innerHTML = '';
            
            people.forEach(person => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input split-checkbox" type="checkbox" id="split_${person.id}" checked>
                    <label class="form-check-label fw-medium" for="split_${person.id}">
                        <span class="person-avatar bg-${person.color}">${person.name.charAt(0)}</span>
                        ${person.name}
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('#mainTabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section and activate nav link
            document.getElementById(sectionName + 'Section').style.display = 'block';
            event.target.classList.add('active');
            
            // Update section content if needed
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'analytics') {
                updateCharts();
            }
        }

        function addExpense() {
            const description = document.getElementById('expenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const paidBy = document.getElementById('paidBy').value;

            // Get who to split with
            const splitBetween = [];
            people.forEach(person => {
                const checkbox = document.getElementById(`split_${person.id}`);
                if (checkbox.checked) {
                    splitBetween.push(person.id);
                }
            });

            if (!description || isNaN(amount) || amount <= 0 || !paidBy || splitBetween.length === 0) {
                showNotification('Please fill all fields correctly!', 'warning');
                return;
            }

            const expense = {
                id: Date.now() + Math.random(),
                description,
                amount,
                date,
                paidBy,
                splitBetween,
                createdAt: new Date().toISOString(),
                type: 'expense'
            };

            expenses.unshift(expense);
            saveData();
            updateUI();
            
            // Reset form
            document.getElementById('expenseForm').reset();
            initializeSplitCheckboxes(); // Reset checkboxes

            showNotification('Expense added successfully!', 'success');
        }

        function recordPayment() {
            const from = document.getElementById('paymentFrom').value;
            const to = document.getElementById('paymentTo').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const notes = document.getElementById('paymentNotes').value;

            if (from === to) {
                showNotification('Cannot record payment to yourself!', 'warning');
                return;
            }

            if (!amount || amount <= 0 || !from || !to) {
                showNotification('Please enter a valid amount!', 'warning');
                return;
            }

            // REVERSED LOGIC: From is receiver, To is payer
            const payment = {
                id: Date.now() + Math.random(),
                from, // Person receiving payment
                to,   // Person making payment
                amount,
                date,
                notes: notes || `Payment from ${getPersonName(to)} to ${getPersonName(from)}`,
                createdAt: new Date().toISOString(),
                type: 'payment'
            };

            payments.unshift(payment);
            saveData();
            updateUI();
            
            // Reset form
            document.getElementById('paymentForm').reset();

            showNotification('Payment recorded successfully!', 'success');
        }

        function saveData() {
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('payments', JSON.stringify(payments));
        }

        function updateUI() {
            updateDashboard();
            loadRecentExpenses();
            loadRecentPayments();
            loadCompleteHistory();
            updateCharts();
        }

        function calculateBalances() {
            const balances = {};
            people.forEach(person => {
                balances[person.id] = 0;
            });

            // Calculate from expenses
            expenses.forEach(expense => {
                const share = expense.amount / expense.splitBetween.length;
                // Person who paid gets positive amount (they spent money)
                balances[expense.paidBy] += expense.amount;
                // People who share get negative amount (they owe money)
                expense.splitBetween.forEach(personId => {
                    balances[personId] -= share;
                });
            });

            // REVERSED PAYMENT LOGIC: When person A pays person B
            // A (payer) balance decreases, B (receiver) balance increases
            payments.forEach(payment => {
                // Person making payment (to) loses money
                balances[payment.to] -= payment.amount;
                // Person receiving payment (from) gains money
                balances[payment.from] += payment.amount;
            });

            return balances;
        }

        function updateDashboard() {
            const balances = calculateBalances();
            
            // Update summary cards
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('totalExpenses').textContent = '‚Çπ' + totalExpenses.toFixed(2);
            
            const pendingCount = Object.values(balances).filter(b => b < -0.01).length;
            document.getElementById('pendingSettlements').textContent = pendingCount;

            // Update debts list
            const debtsList = document.getElementById('debtsList');
            const debts = people.filter(p => balances[p.id] < -0.01)
                .map(p => ({ person: p, amount: Math.abs(balances[p.id]) }));
            
            debtsList.innerHTML = debts.length === 0 ? 
                '<div class="text-center text-muted p-4"><i class="bi bi-emoji-smile fs-1"></i><p class="mt-2">No debts! üéâ</p></div>' :
                debts.map(debt => `
                    <div class="transaction-card debt-item p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="person-avatar bg-${debt.person.color}">${debt.person.name.charAt(0)}</span>
                                <div>
                                    <strong>${debt.person.name}</strong>
                                    <div class="text-muted small">Owes money</div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="amount-badge bg-warning text-white">‚Çπ${debt.amount.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

            // Update credits list
            const creditsList = document.getElementById('creditsList');
            const credits = people.filter(p => balances[p.id] > 0.01)
                .map(p => ({ person: p, amount: balances[p.id] }));
            
            creditsList.innerHTML = credits.length === 0 ? 
                '<div class="text-center text-muted p-4"><i class="bi bi-emoji-smile fs-1"></i><p class="mt-2">No credits! üéâ</p></div>' :
                credits.map(credit => `
                    <div class="transaction-card credit-item p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="person-avatar bg-${credit.person.color}">${credit.person.name.charAt(0)}</span>
                                <div>
                                    <strong>${credit.person.name}</strong>
                                    <div class="text-muted small">Is owed money</div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="amount-badge bg-success">‚Çπ${credit.amount.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

            // Update settlement suggestions - REVERSED for new payment logic
            const suggestionsDiv = document.getElementById('settlementSuggestions');
            const suggestions = calculateOptimalSettlements(balances);
            
            suggestionsDiv.innerHTML = suggestions.length === 0 ? 
                '<div class="text-center text-muted p-4"><i class="bi bi-emoji-laughing fs-1"></i><p class="mt-2">All settled up! üéâ</p></div>' :
                suggestions.map(suggestion => `
                    <div class="transaction-card p-3 mb-3 settlement-suggestion" style="border-left: 4px solid #4361ee;" 
                         onclick="quickSettle('${suggestion.to.id}', '${suggestion.from.id}', ${suggestion.amount})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="person-avatar bg-${suggestion.from.color}">${suggestion.from.name.charAt(0)}</span>
                                <span class="mx-2"><i class="bi bi-arrow-right text-muted"></i></span>
                                <span class="person-avatar bg-${suggestion.to.color}">${suggestion.to.name.charAt(0)}</span>
                                <div class="ms-3">
                                    <strong>${suggestion.from.name} ‚Üê ${suggestion.to.name}</strong>
                                    <div class="text-muted small">${suggestion.to.name} should pay ${suggestion.from.name}</div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="amount-badge bg-primary">‚Çπ${suggestion.amount.toFixed(2)}</div>
                                <div class="mt-1"><small class="text-muted">Tap to record payment</small></div>
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        function calculateOptimalSettlements(balances) {
            const debtors = people.filter(p => balances[p.id] < -0.01)
                .map(p => ({ person: p, amount: Math.abs(balances[p.id]) }))
                .sort((a, b) => b.amount - a.amount);
            
            const creditors = people.filter(p => balances[p.id] > 0.01)
                .map(p => ({ person: p, amount: balances[p.id] }))
                .sort((a, b) => b.amount - a.amount);

            const settlements = [];
            let i = 0, j = 0;

            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];
                
                const amount = Math.min(debtor.amount, creditor.amount);
                
                if (amount > 0.01) {
                    settlements.push({
                        from: creditor.person, // Person who should receive
                        to: debtor.person,     // Person who should pay
                        amount: amount
                    });
                    
                    debtor.amount -= amount;
                    creditor.amount -= amount;
                    
                    if (debtor.amount < 0.01) i++;
                    if (creditor.amount < 0.01) j++;
                }
            }

            return settlements;
        }

        function quickSettle(receiverId, payerId, amount) {
            // Set the payment form with reversed logic
            document.getElementById('paymentFrom').value = receiverId; // Who receives
            document.getElementById('paymentTo').value = payerId;     // Who pays
            document.getElementById('paymentAmount').value = amount.toFixed(2);
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentNotes').value = 'Settlement payment';
            showSection('settlements');
            
            // Scroll to payment form and focus on amount
            document.getElementById('paymentAmount').focus();
        }

        function generatePDFReport() {
            const balances = calculateBalances();
            const debts = people.filter(p => balances[p.id] < -0.01);
            const credits = people.filter(p => balances[p.id] > 0.01);
            const recentTransactions = [...expenses, ...payments]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);
            
            const settlements = calculateOptimalSettlements(balances);
            
            // Create comprehensive PDF preview
            const previewContent = document.getElementById('pdfPreviewContent');
            let html = `
                <div style="font-family: Arial, sans-serif; color: #333; max-width: 100%;">
                    <div style="text-align: center; background: linear-gradient(135deg, #4361ee, #3a0ca3); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
                        <h1 style="margin: 0; font-size: 2.5em;">üí∞ Expense Splitter </h1>
                        <p style="margin: 10px 0 0 0; font-size: 1.2em; opacity: 0.9;">Complete Financial Report</p>
                        <p style="margin: 5px 0 0 0; opacity: 0.8;">Generated on ${new Date().toLocaleDateString()}</p>
                    </div>

                    <!-- Summary Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="color: #4361ee; margin: 0;">‚Çπ${expenses.reduce((sum, exp) => sum + exp.amount, 0).toFixed(2)}</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Total Expenses</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="color: #4361ee; margin: 0;">${expenses.length + payments.length}</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Total Transactions</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="color: #4361ee; margin: 0;">${debts.length}</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Pending Settlements</p>
                        </div>
                    </div>

                    <!-- Current Balances -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h3 style="color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;">üìâ Who Owes Money</h3>
            `;

            if (debts.length === 0) {
                html += '<p style="color: #666; text-align: center; padding: 20px;">No debts! üéâ</p>';
            } else {
                debts.forEach(debt => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff5f5; margin: 10px 0; border-radius: 8px; border-left: 4px solid #e74c3c;">
                            <div>
                                <strong>${debt.name}</strong>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">Owes money to others</p>
                            </div>
                            <span style="background: #e74c3c; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                                ‚Çπ${Math.abs(balances[debt.id]).toFixed(2)}
                            </span>
                        </div>
                    `;
                });
            }

            html += `
                        </div>
                        <div>
                            <h3 style="color: #27ae60; border-bottom: 2px solid #27ae60; padding-bottom: 10px;">üìà Who is Owed Money</h3>
            `;

            if (credits.length === 0) {
                html += '<p style="color: #666; text-align: center; padding: 20px;">No credits! üéâ</p>';
            } else {
                credits.forEach(credit => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f0fff4; margin: 10px 0; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <div>
                                <strong>${credit.name}</strong>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">Is owed money by others</p>
                            </div>
                            <span style="background: #27ae60; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                                ‚Çπ${balances[credit.id].toFixed(2)}
                            </span>
                        </div>
                    `;
                });
            }

            html += `
                        </div>
                    </div>

                    <!-- Settlement Suggestions -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="color: #4361ee; text-align: center; margin-bottom: 20px;">‚ö° Settlement Plan</h3>
            `;

            if (settlements.length === 0) {
                html += '<p style="text-align: center; color: #666;">All settled up! üéâ</p>';
            } else {
                settlements.forEach(suggestion => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; margin: 10px 0; border-radius: 8px; border-left: 4px solid #4361ee;">
                            <div style="display: flex; align-items: center;">
                                <div style="background: #e74c3c; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">
                                    ${suggestion.to.name.charAt(0)}
                                </div>
                                <i class="bi bi-arrow-right" style="margin: 0 10px; color: #666;"></i>
                                <div style="background: #27ae60; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-left: 15px;">
                                    ${suggestion.from.name.charAt(0)}
                                </div>
                                <div style="margin-left: 20px;">
                                    <strong>${suggestion.to.name} should pay ${suggestion.from.name}</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">To settle outstanding balance</p>
                                </div>
                            </div>
                            <span style="background: #4361ee; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                                ‚Çπ${suggestion.amount.toFixed(2)}
                            </span>
                        </div>
                    `;
                });
            }

            html += `
                    </div>

                    <!-- Last 10 Transactions -->
                    <div style="background: white; border: 1px solid #e9ecef; border-radius: 10px; padding: 0; overflow: hidden; margin-bottom: 30px;">
                        <h3 style="background: #4361ee; color: white; margin: 0; padding: 20px;">üìã Last 10 Transactions</h3>
                        <div style="padding: 20px;">
            `;

            if (recentTransactions.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 20px;">No transactions yet</p>';
            } else {
                recentTransactions.forEach((transaction, index) => {
                    if (transaction.type === 'expense') {
                        const paidBy = people.find(p => p.id === transaction.paidBy);
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: ${index < recentTransactions.length - 1 ? '1px solid #f1f3f4' : 'none'};">
                                <div>
                                    <strong>${transaction.description}</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">
                                        üí∞ Expense ‚Ä¢ Paid by ${paidBy.name} ‚Ä¢ ${new Date(transaction.date).toLocaleDateString()}
                                    </p>
                                </div>
                                <span style="color: #4361ee; font-weight: bold;">-‚Çπ${transaction.amount.toFixed(2)}</span>
                            </div>
                        `;
                    } else {
                        const fromPerson = people.find(p => p.id === transaction.from);
                        const toPerson = people.find(p => p.id === transaction.to);
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: ${index < recentTransactions.length - 1 ? '1px solid #f1f3f4' : 'none'};">
                                <div>
                                    <strong>Payment: ${toPerson.name} ‚Üí ${fromPerson.name}</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">
                                        üí∏ Settlement ‚Ä¢ ${transaction.notes} ‚Ä¢ ${new Date(transaction.date).toLocaleDateString()}
                                    </p>
                                </div>
                                <span style="color: #27ae60; font-weight: bold;">‚Çπ${transaction.amount.toFixed(2)}</span>
                            </div>
                        `;
                    }
                });
            }

            html += `
                        </div>
                    </div>

                    <!-- Detailed Breakdown -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="color: #4361ee; text-align: center; margin-bottom: 20px;">üìä Detailed Breakdown</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="color: #e74c3c; margin-bottom: 15px;">Expenses Summary</h4>
                                <p><strong>Total Expenses:</strong> ‚Çπ${expenses.reduce((sum, exp) => sum + exp.amount, 0).toFixed(2)}</p>
                                <p><strong>Number of Expenses:</strong> ${expenses.length}</p>
                                <p><strong>Average per Expense:</strong> ‚Çπ${expenses.length > 0 ? (expenses.reduce((sum, exp) => sum + exp.amount, 0) / expenses.length).toFixed(2) : '0.00'}</p>
                            </div>
                            <div>
                                <h4 style="color: #27ae60; margin-bottom: 15px;">Payments Summary</h4>
                                <p><strong>Total Payments:</strong> ‚Çπ${payments.reduce((sum, pay) => sum + pay.amount, 0).toFixed(2)}</p>
                                <p><strong>Number of Payments:</strong> ${payments.length}</p>
                                <p><strong>Average per Payment:</strong> ‚Çπ${payments.length > 0 ? (payments.reduce((sum, pay) => sum + pay.amount, 0) / payments.length).toFixed(2) : '0.00'}</p>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <p style="margin: 0; color: #666;">Generated with ‚ù§Ô∏è by Expense Splitter Pro</p>
                        <p style="margin: 5px 0 0 0; color: #999; font-size: 0.9em;">Keep tracking, keep splitting! üöÄ</p>
                    </div>
                </div>
            `;

            previewContent.innerHTML = html;

            // Show preview modal
            const pdfModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
            pdfModal.show();
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get all the data for PDF
            const balances = calculateBalances();
            const debts = people.filter(p => balances[p.id] < -0.01);
            const credits = people.filter(p => balances[p.id] > 0.01);
            const recentTransactions = [...expenses, ...payments]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);
            const settlements = calculateOptimalSettlements(balances);
            
            let yPosition = 20;
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(67, 97, 238);
            doc.text('Expense Splitter Pro Report', 20, yPosition);
            yPosition += 10;
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, yPosition);
            yPosition += 20;
            
            // Summary
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Financial Summary', 20, yPosition);
            yPosition += 15;
            
            doc.setFontSize(12);
            doc.text(`Total Expenses: ‚Çπ${expenses.reduce((sum, exp) => sum + exp.amount, 0).toFixed(2)}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Total Transactions: ${expenses.length + payments.length}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Pending Settlements: ${debts.length}`, 20, yPosition);
            yPosition += 20;
            
            // Debts and Credits
            doc.setFontSize(14);
            doc.text('Current Balances:', 20, yPosition);
            yPosition += 15;
            
            doc.setFontSize(12);
            if (debts.length > 0) {
                doc.setTextColor(231, 76, 60);
                doc.text('Who Owes Money:', 20, yPosition);
                yPosition += 10;
                debts.forEach(debt => {
                    doc.text(`‚Ä¢ ${debt.name}: ‚Çπ${Math.abs(balances[debt.id]).toFixed(2)}`, 25, yPosition);
                    yPosition += 8;
                });
                yPosition += 5;
            }
            
            if (credits.length > 0) {
                doc.setTextColor(39, 174, 96);
                doc.text('Who is Owed Money:', 20, yPosition);
                yPosition += 10;
                credits.forEach(credit => {
                    doc.text(`‚Ä¢ ${credit.name}: ‚Çπ${balances[credit.id].toFixed(2)}`, 25, yPosition);
                    yPosition += 8;
                });
                yPosition += 5;
            }
            
            doc.setTextColor(0, 0, 0);
            
            // Settlement Suggestions
            if (settlements.length > 0) {
                doc.setFontSize(14);
                doc.text('Settlement Plan:', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(12);
                settlements.forEach(suggestion => {
                    doc.text(`‚Ä¢ ${suggestion.to.name} ‚Üí ${suggestion.from.name}: ‚Çπ${suggestion.amount.toFixed(2)}`, 25, yPosition);
                    yPosition += 8;
                });
                yPosition += 10;
            }
            
            // Recent Transactions
            if (recentTransactions.length > 0) {
                doc.setFontSize(14);
                doc.text('Last 10 Transactions:', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(10);
                recentTransactions.forEach(transaction => {
                    if (transaction.type === 'expense') {
                        const paidBy = people.find(p => p.id === transaction.paidBy);
                        doc.text(`üí∞ ${transaction.description} (Paid by ${paidBy.name}): -‚Çπ${transaction.amount.toFixed(2)}`, 25, yPosition);
                    } else {
                        const fromPerson = people.find(p => p.id === transaction.from);
                        const toPerson = people.find(p => p.id === transaction.to);
                        doc.text(`üí∏ ${toPerson.name} ‚Üí ${fromPerson.name}: ‚Çπ${transaction.amount.toFixed(2)}`, 25, yPosition);
                    }
                    yPosition += 8;
                });
            }
            
            // Save the PDF
            doc.save(`expense-report-${new Date().toISOString().split('T')[0]}.pdf`);
            
            showNotification('PDF downloaded successfully!', 'success');
            
            // Close modal
            const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfPreviewModal'));
            pdfModal.hide();
        }

        // ... (rest of the functions remain the same as previous version)
        function loadRecentExpenses() {
            const recent = expenses.slice(0, 5);
            const container = document.getElementById('recentExpenses');
            
            container.innerHTML = recent.length === 0 ? 
                '<div class="text-center text-muted p-4">No expenses yet</div>' :
                recent.map(expense => {
                    const paidBy = people.find(p => p.id === expense.paidBy);
                    return `
                        <div class="transaction-card expense-item p-3 mb-3">
                            <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteExpense('${expense.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>${expense.description}</strong>
                                            <div class="text-muted small">
                                                <span class="person-avatar bg-${paidBy.color}">${paidBy.name.charAt(0)}</span>
                                                Paid by ${paidBy.name} ‚Ä¢ ${new Date(expense.date).toLocaleDateString()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="text-muted">Split between ${expense.splitBetween.length} people</span>
                                <span class="fw-bold text-primary">‚Çπ${expense.amount.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function loadRecentPayments() {
            const recent = payments.slice(0, 5);
            const container = document.getElementById('recentPayments');
            
            container.innerHTML = recent.length === 0 ? 
                '<div class="text-center text-muted p-4">No payments yet</div>' :
                recent.map(payment => {
                    const fromPerson = people.find(p => p.id === payment.from);
                    const toPerson = people.find(p => p.id === payment.to);
                    return `
                        <div class="transaction-card payment-item p-3 mb-3">
                            <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deletePayment('${payment.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="d-flex align-items-center">
                                                <span class="person-avatar bg-${toPerson.color}">${toPerson.name.charAt(0)}</span>
                                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                                <span class="person-avatar bg-${fromPerson.color}">${fromPerson.name.charAt(0)}</span>
                                            </div>
                                            <div class="text-muted small mt-1">
                                                ${payment.notes} ‚Ä¢ ${new Date(payment.date).toLocaleDateString()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-2">
                                <span class="fw-bold text-success">‚Çπ${payment.amount.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // ... (other functions like deleteExpense, deletePayment, etc. remain the same)

        function getPersonName(id) {
            const person = people.find(p => p.id === id);
            return person ? person.name : 'Unknown';
        }

        function showNotification(message, type) {
            document.querySelectorAll('.alert-notification').forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-notification alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 4000);
        }

        // Initialize charts and other functions...
        function initializeCharts() {
            // Spending Chart
            const ctx1 = document.getElementById('spendingChart').getContext('2d');
            window.spendingChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: people.map(p => p.name),
                    datasets: [{
                        label: 'Total Spent',
                        data: people.map(() => 0),
                        backgroundColor: '#4361ee',
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Spending by Person' }
                    }
                }
            });

            // Distribution Chart
            const ctx2 = document.getElementById('distributionChart').getContext('2d');
            window.distributionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: people.map(p => p.name),
                    datasets: [{
                        data: people.map(() => 0),
                        backgroundColor: ['#4361ee', '#4cc9f0', '#f72585', '#7209b7']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function updateCharts() {
            const spentData = people.map(person => {
                return expenses
                    .filter(exp => exp.paidBy === person.id)
                    .reduce((sum, exp) => sum + exp.amount, 0);
            });

            if (window.spendingChart) {
                window.spendingChart.data.datasets[0].data = spentData;
                window.spendingChart.update();
            }

            if (window.distributionChart) {
                window.distributionChart.data.datasets[0].data = spentData;
                window.distributionChart.update();
            }
        }

        function filterHistory(searchTerm) {
            const items = document.querySelectorAll('#completeHistory .transaction-card');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm.toLowerCase()) ? 'block' : 'none';
            });
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                expenses = [];
                payments = [];
                saveData();
                updateUI();
                showNotification('All data cleared!', 'info');
            }
        }

        function exportToCSV() {
            let csv = 'Type,Description,Amount,From,To,Date,Notes\n';
            
            expenses.forEach(expense => {
                const paidBy = people.find(p => p.id === expense.paidBy);
                csv += `Expense,${expense.description},${expense.amount},${paidBy.name},,${expense.date},Shared by ${expense.splitBetween.length} people\n`;
            });

            payments.forEach(payment => {
                const fromPerson = people.find(p => p.id === payment.from);
                const toPerson = people.find(p => p.id === payment.to);
                csv += `Payment,${payment.notes},${payment.amount},${toPerson.name},${fromPerson.name},${payment.date},\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('CSV exported successfully!', 'success');
        }

        function backupData() {
            const backup = {
                expenses: expenses,
                payments: payments,
                backupDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expense-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Data backed up successfully!', 'success');
        }

        function showQuickExpenseModal() {
            const modal = new bootstrap.Modal(document.getElementById('quickExpenseModal'));
            modal.show();
        }

        function addQuickExpense() {
            const description = document.getElementById('quickDesc').value;
            const amount = parseFloat(document.getElementById('quickAmount').value);
            const paidBy = document.getElementById('quickPaidBy').value;

            if (!description || !amount) {
                showNotification('Please enter description and amount!', 'warning');
                return;
            }

            const expense = {
                id: Date.now() + Math.random(),
                description,
                amount,
                date: new Date().toISOString().split('T')[0],
                paidBy,
                splitBetween: people.map(p => p.id),
                createdAt: new Date().toISOString(),
                type: 'expense'
            };

            expenses.unshift(expense);
            saveData();
            updateUI();

            const modal = bootstrap.Modal.getInstance(document.getElementById('quickExpenseModal'));
            modal.hide();

            showNotification('Quick expense added!', 'success');
        }

        function loadCompleteHistory() {
            const allItems = [
                ...expenses.map(exp => ({ ...exp, itemType: 'expense' })),
                ...payments.map(pay => ({ ...pay, itemType: 'payment' }))
            ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const container = document.getElementById('completeHistory');
            
            container.innerHTML = allItems.length === 0 ? 
                '<div class="text-center text-muted p-5"><i class="bi bi-inbox fs-1"></i><p class="mt-2">No history yet</p></div>' :
                allItems.map(item => {
                    if (item.itemType === 'expense') {
                        const paidBy = people.find(p => p.id === item.paidBy);
                        return `
                            <div class="transaction-card expense-item p-3 mb-3">
                                <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteExpense('${item.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <i class="bi bi-receipt text-primary me-2"></i>
                                                <strong>${item.description}</strong>
                                                <div class="text-muted small mt-1">
                                                    <span class="person-avatar bg-${paidBy.color}">${paidBy.name.charAt(0)}</span>
                                                    Paid by ${paidBy.name} ‚Ä¢ ${new Date(item.date).toLocaleDateString()}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="text-muted">${item.splitBetween.length} people shared</span>
                                    <span class="fw-bold text-primary">‚Çπ${item.amount.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        const fromPerson = people.find(p => p.id === item.from);
                        const toPerson = people.find(p => p.id === item.to);
                        return `
                            <div class="transaction-card payment-item p-3 mb-3">
                                <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deletePayment('${item.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <i class="bi bi-cash-coin text-success me-2"></i>
                                                <strong>Payment</strong>
                                                <div class="text-muted small mt-1">
                                                    <span class="person-avatar bg-${toPerson.color}">${toPerson.name.charAt(0)}</span>
                                                    ${toPerson.name} 
                                                    <i class="bi bi-arrow-right mx-1"></i>
                                                    <span class="person-avatar bg-${fromPerson.color}">${fromPerson.name.charAt(0)}</span>
                                                    ${fromPerson.name} ‚Ä¢ ${new Date(item.date).toLocaleDateString()}
                                                </div>
                                                <div class="text-muted small">${item.notes}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end mt-2">
                                    <span class="fw-bold text-success">‚Çπ${item.amount.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
        }

        function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense?')) {
                const idToDelete = parseFloat(expenseId);
                expenses = expenses.filter(exp => exp.id !== idToDelete);
                saveData();
                updateUI();
                showNotification('Expense deleted successfully!', 'info');
            }
        }

        function deletePayment(paymentId) {
            if (confirm('Are you sure you want to delete this payment?')) {
                const idToDelete = parseFloat(paymentId);
                payments = payments.filter(pay => pay.id !== idToDelete);
                saveData();
                updateUI();
                showNotification('Payment deleted successfully!', 'info');
            }
        }
    </script>
</body>
</html>